<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arraunean !</title>

<style>
@font-face {
  font-family: "Satoshi";
  src: url("fonts/Satoshi-Regular.woff2") format("woff2");
  font-weight: 400;
}
@font-face {
  font-family: "Satoshi";
  src: url("fonts/Satoshi-Bold.woff2") format("woff2");
  font-weight: 700;
}

body{
  margin:0;
  background:#0f172a;
  color:white;
  font-family:"Satoshi", system-ui, sans-serif;
  display:flex;
  justify-content:center;
  padding:20px;
}

.widget{
  width:300px;
  text-align:center;
  position:relative;
}

/* HEADER LANG / TOGGLE */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.flag{
  width:28px;
  height:28px;
  border-radius:50%;
  cursor:pointer;
  opacity:0.5;
  object-fit:cover;
  object-position:center;
  margin-right:4px;
  transition:opacity 0.3s, transform 0.3s;
}
.flag.active{
  opacity:1;
}

/* TOGGLE PONDERATION */
.toggle{
  position:relative;
  width:44px;
  height:24px;
  border-radius:12px;
  background:#555;
  cursor:pointer;
}
.toggle::after{
  content:"";
  position:absolute;
  width:20px;
  height:20px;
  background:white;
  border-radius:50%;
  top:2px;
  left:2px;
  transition:0.3s;
}
.toggle.on{
  background:#2ec4b6;
}
.toggle.on::after{
  left:22px;
}
.toggle-tooltip{
  position:absolute;
  bottom:28px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.7);
  color:white;
  font-size:12px;
  padding:2px 6px;
  border-radius:4px;
  opacity:0;
  transition:opacity 0.3s;
  pointer-events:none;
}
.toggle:hover + .toggle-tooltip{
  opacity:1; /* affichage hover desktop */
}

/* TITLE */
h1{
  margin:0 0 12px;
  font-size:30px;
  font-weight:700;
}

/* CERCLE */
.circle{
  width:180px;
  height:180px;
  border-radius:50%;
  background:#1e293b;
  margin:auto;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
  cursor:pointer;
  transition:background 1.2s ease;
}
.circle::after{
  content:"";
  position:absolute;
  width:155px;
  height:155px;
  background:#0f172a;
  border-radius:50%;
}
.percent{
  position:relative;
  z-index:1;
}
.value{
  font-size:65px;
  font-weight:700;
}
.symbol{
  position:absolute;
  font-size:18px;
  top:16px;
  right:-18px;
  opacity:0.7;
}

/* DETAILS */
.details{
  position:relative;
  margin-top:16px;
  width:260px; /* aligné avec le cercle */
  text-align:left;
  display:none;
  margin:auto;
  margin-top:16px;
}
.task{
  margin-bottom:10px;
}
.task-name{
  font-size:14px;
  margin-bottom:4px;
  opacity:0;
  transition:opacity 0.4s;
}
.bar{
  background:#1e293b;
  height:8px;
  border-radius:6px;
  overflow:hidden;
}
.bar-fill{
  height:100%;
  width:0%;
  transition:width 0.8s ease, background 0.4s;
}

/* QUOTES */
.quote{
  font-style:italic;
  text-align:center;
  color:#9aa3b2;
  margin-top:22px; /* léger décalage */
  min-height:40px;
  transition:opacity 0.6s;
}

/* LOGO AUDIO */
.logo{
  width:60px;
  margin:12px auto 0;
  cursor:pointer;
  display:block;
  transition:transform 0.3s;
}
.logo.playing{
  animation:pulse 1.5s infinite;
}
@keyframes pulse{
  0%{transform:scale(1);}
  50%{transform:scale(1.06);}
  100%{transform:scale(1);}
}
</style>
<link rel="manifest" href="manifest.json">
</head>

<body>
<div class="widget">

  <div class="header">
    <div class="lang">
      <img src="assets/flags/fr.svg" id="fr" class="flag">
      <img src="assets/flags/eu.svg" id="eu" class="flag">
    </div>
    <div style="position:relative;">
      <div id="weightToggle" class="toggle"></div>
      <div id="toggleTooltip" class="toggle-tooltip">Pondérer</div>
    </div>
  </div>

  <h1>Arraunean !</h1>

  <div class="circle" id="circle">
    <div class="percent">
      <span class="value" id="globalValue">0</span>
      <span class="symbol">%</span>
    </div>
  </div>

  <div class="details" id="details"></div>

  <div class="quote" id="quote"></div>

  <img src="assets/logo/logo.svg" class="logo" id="logo">

  <audio id="audio" src="audio/extrait.mp3"></audio>

</div>

<script>
const AUDIO_INFO_URL = "data/audio.json";
let lastAudioVersion = localStorage.getItem("lastAudioVersion");
  
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwQzqpPLn7_EHjCo9rzmdUBhtY6IjonFgZ4IOhJONCbboDPVDcaUX8yMCKXLMN3NSam/exec";
const INSTA_WEB="https://www.instagram.com/ensemblekutun/";

let lang=localStorage.getItem("lang")||"fr";
let weighted=localStorage.getItem("weighted")==="true";
let detailsOpened=false;
let previousGlobal=0;
let currentQuoteIndex=-1;

const circleEl=document.getElementById("circle");
const globalValue=document.getElementById("globalValue");
const detailsEl=document.getElementById("details");
const quoteEl=document.getElementById("quote");
const weightToggle=document.getElementById("weightToggle");
const toggleTooltip=document.getElementById("toggleTooltip");
const logo=document.getElementById("logo");
const audio=document.getElementById("audio");

document.getElementById(lang).classList.add("active");
if(weighted) weightToggle.classList.add("on");
toggleTooltip.textContent = lang==="fr"?"Pondérer":"Orekatu";

async function checkAudioUpdate(){
  try{
    const res = await fetch(`${AUDIO_INFO_URL}?t=${Date.now()}`);
    const audioInfo = await res.json();

    if(audioInfo.version && audioInfo.version !== lastAudioVersion){
      // Notification
      if(Notification.permission === "granted" && navigator.serviceWorker.controller){
        navigator.serviceWorker.controller.postMessage({
          type:"NOTIFY",
          title:"Arraunean !",
          options:{
            body:"Un nouvel extrait sonore est disponible",
            icon:"assets/logo/logo-192.png"
          }
        });
      }

      // Mise à jour locale
      lastAudioVersion = audioInfo.version;
      localStorage.setItem("lastAudioVersion", audioInfo.version);

      // Met à jour la source audio si besoin
      audio.src = audioInfo.file;
    }
  }catch(e){
    console.log("Audio check error", e);
  }
}

/* UTIL */
function colorFromPercent(p){return `hsl(${p*1.2},80%,45%)`;}
function animateNumber(from,to,cb){let v=from;function step(){if(v===to)return;v+=v<to?1:-1;cb(v);requestAnimationFrame(step);}step();}

/* PWA & Notifications */
if ('serviceWorker' in navigator && 'Notification' in window) {
  navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered'));
  
  if (Notification.permission !== 'granted') {
    Notification.requestPermission();
  }
}

/* UPDATE DATA */
async function updateData(){
  const res=await fetch(`${SCRIPT_URL}?lang=${lang}&weighted=${weighted}&t=${Date.now()}`);
  const data=await res.json();
  const g=Math.round(data.global);

  // Cercle animation
  animateNumber(previousGlobal,g,v=>{
    const c=colorFromPercent(v);
    circleEl.style.background=`conic-gradient(${c} ${v*3.6}deg, #1e293b 0deg)`;
    globalValue.textContent=v;
  });

  // Notifications
  if(previousGlobal>0 && g>previousGlobal && Notification.permission==='granted' && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({
      type:'NOTIFY',
      title:'Arraunean !',
      options:{body:`Beti aintzina ! %${g}(e)tara helduz — La progression globale a avancé à ${g}%`,icon:'assets/logo/logo-192.png'}
    });
  }

  if(data.audioVersion && data.audioVersion!==localStorage.getItem('lastAudioVersion') && Notification.permission==='granted' && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({
      type:'NOTIFY',
      title:'Arraunean !',
      options:{body:'Musika zati berri bat entzuteko ! — Un nouvel extrait audio est disponible !',icon:'assets/logo/logo-192.png'}
    });
    localStorage.setItem('lastAudioVersion',data.audioVersion);
  }

  previousGlobal=g;

  if(detailsOpened){
    detailsEl.innerHTML="";
    data.details.forEach(d=>{
      const t=document.createElement("div");
      t.className="task";
      t.innerHTML=`
        <div class="task-name">${d.name} – ${Math.round(d.progress)}%</div>
        <div class="bar">
          <div class="bar-fill" style="width:${Math.round(d.progress)}%;background:${colorFromPercent(d.progress)}"></div>
        </div>`;
      detailsEl.appendChild(t);
      requestAnimationFrame(()=>t.querySelector(".task-name").style.opacity=1);
    });
  }
}

/* DETAILS TOGGLE */
circleEl.onclick=()=>{
  detailsOpened=!detailsOpened;
  detailsEl.style.display=detailsOpened?"block":"none";
  if(detailsOpened) updateData();
};

/* PONDERATION TOGGLE */
weightToggle.onclick=()=>{
  weighted=!weighted;
  weightToggle.classList.toggle("on");
  updateTooltip();
  localStorage.setItem("weighted",weighted);
  updateData();
};
function updateTooltip(){toggleTooltip.textContent=lang==="fr"?"Pondérer":"Orekatu";}
let pressTimer;
weightToggle.ontouchstart=()=>{pressTimer=setTimeout(()=>{toggleTooltip.style.opacity=1;setTimeout(()=>toggleTooltip.style.opacity=0,800);},500);};
weightToggle.ontouchend=()=>clearTimeout(pressTimer);

/* LANGUES */
["fr","eu"].forEach(l=>{
  document.getElementById(l).onclick=()=>{
    if(l===lang) return;
    detailsEl.querySelectorAll(".task-name").forEach(e=>e.style.opacity=0);
    setTimeout(()=>{
      lang=l;
      localStorage.setItem("lang",lang);
      document.querySelectorAll(".flag").forEach(f=>f.classList.remove("active"));
      document.getElementById(l).classList.add("active");
      updateTooltip();
      updateData();
    },300);
  };
});

/* AUDIO / LOGO */
logo.onclick=()=>{
  if(audio.paused){audio.currentTime=0; audio.play(); logo.classList.add("playing");}
  else {audio.pause(); logo.classList.remove("playing");}
};
audio.onended=()=>logo.classList.remove("playing");
logo.ondblclick=()=>window.open(INSTA_WEB,"_blank");
let pressTimerLogo;
logo.ontouchstart=()=>pressTimerLogo=setTimeout(()=>window.open(INSTA_WEB,"_blank"),500);
logo.ontouchend=()=>clearTimeout(pressTimerLogo);

/* QUOTES */
fetch("data/quotes.json").then(r=>r.json()).then(quotes=>{
  function changeQuote(){
    let nextIndex;
    do{nextIndex=Math.floor(Math.random()*quotes.length);}while(nextIndex===currentQuoteIndex);
    currentQuoteIndex=nextIndex;
    quoteEl.style.opacity=0;
    setTimeout(()=>{quoteEl.textContent=quotes[currentQuoteIndex];quoteEl.style.opacity=1;},600);
  }
  changeQuote();
  setInterval(changeQuote,120000);
});

/* Cercle animation micro-fluide toutes les 20 sec */
setInterval(()=>{
  circleEl.style.transform="scale(1.02)";
  setTimeout(()=>circleEl.style.transform="scale(1)",600);
},20000);

updateData();
setInterval(updateData,30000);

checkAudioUpdate();
setInterval(checkAudioUpdate, 60000); // toutes les 1 min
</script>

</body>
</html>
