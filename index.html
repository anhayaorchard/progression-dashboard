<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Arraunean</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0f172a">
<link rel="manifest" href="manifest.json">

<style>
/* =======================
   POLICE SATOSHI
   ======================= */
@font-face {
    font-family: "Satoshi";
    src: url("fonts/Satoshi-Regular.woff2") format("woff2");
    font-weight: 400;
}
@font-face {
    font-family: "Satoshi";
    src: url("fonts/Satoshi-Medium.woff2") format("woff2");
    font-weight: 500;
}
@font-face {
    font-family: "Satoshi";
    src: url("fonts/Satoshi-Bold.woff2") format("woff2");
    font-weight: 700;
}

/* =======================
   BASE
   ======================= */
body {
    margin: 0;
    background: #0f172a;
    color: white;
    font-family: "Satoshi", system-ui, Arial sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.widget {
    width: 260px;
    text-align: center;
}

/* =======================
   TITRE
   ======================= */
h1 {
    margin: 0 0 12px 0;
    font-size: 30px;
    font-weight: 600;
    letter-spacing: 0.6px;
}

/* =======================
   CERCLE DE PROGRESSION
   ======================= */
.circle {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: #1e293b;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: auto;
    cursor: pointer;
    position: relative;
}

/* Anneau fin */
.circle::after {
    content: "";
    position: absolute;
    width: 155px;
    height: 155px;
    background: #0f172a;
    border-radius: 50%;
}

/* Pourcentage */
.percent {
    position: relative;
    z-index: 1;
}

.value {
    font-size: 60px;
    font-weight: 700;
    line-height: 1;
}

.symbol {
    position: absolute;
    font-size: 16px;
    top: 3px;
    right: -16px;
    opacity: 0.75;
}

/* =======================
   DETAILS
   ======================= */
.details {
    margin-top: 16px;
    display: none;
    text-align: left;
}

.task {
    margin-bottom: 12px;
}

.task-name {
    font-size: 14px;
    margin-bottom: 4px;
}

.bar {
    background: #1e293b;
    border-radius: 6px;
    overflow: hidden;
    height: 8px;
}

.bar-fill {
    height: 100%;
    width: 0%;
    transition: width 0.8s ease;
}

/* =======================
   PULSATION
   ======================= */
@keyframes pulse {
    0%   { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
    50%  { transform: scale(1.04); box-shadow: 0 0 18px rgba(34,197,94,0.35); }
    100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
}

.pulse {
    animation: pulse 1.2s ease-in-out;
}
</style>
</head>

<body>

<div class="widget">
    <h1>Arraunean !</h1>

    <div class="circle" id="circle">
        <div class="percent">
            <span class="value" id="globalValue">0</span>
            <span class="symbol">%</span>
        </div>
    </div>

    <div class="details" id="details"></div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbx-UTYO7SudKRVHLj97UbKfLJIUP0rwCKLBfkeaQztXaQD_xP5MgDPBPvV7idm5qQk/exec";

const circle = document.getElementById("circle");
const globalValue = document.getElementById("globalValue");
const details = document.getElementById("details");

/* Toggle détails */
circle.addEventListener("click", () => {
    details.style.display = details.style.display === "none" ? "block" : "none";
});

/* Couleur rouge → vert */
function colorFromPercent(p) {
    const hue = Math.round(p * 1.2); // 0 → 120
    return `hsl(${hue}, 80%, 45%)`;
}

/* Animation progressive */
function animateCircle(target) {
    let current = 0;
    function step() {
        current++;
        const color = colorFromPercent(current);

        circle.style.background =
            `conic-gradient(${color} ${current * 3.6}deg, #1e293b 0deg)`;

        globalValue.textContent = current;

        if (current < target) requestAnimationFrame(step);
    }
    step();
}

/* Pulsation toutes les 20s */
setInterval(() => {
    circle.classList.add("pulse");
    setTimeout(() => circle.classList.remove("pulse"), 1200);
}, 20000);

/* Chargement des données */
fetch(URL)
.then(res => res.json())
.then(data => {
    const global = Math.round(data.global);
    animateCircle(global);

    data.details.forEach(task => {
        const p = Math.round(task.progress);
        const color = colorFromPercent(p);

        const div = document.createElement("div");
        div.className = "task";

        div.innerHTML = `
            <div class="task-name">${task.name} – ${p}%</div>
            <div class="bar">
                <div class="bar-fill" style="width:${p}%; background:${color};"></div>
            </div>
        `;

        details.appendChild(div);
    });
})
.catch(err => {
    globalValue.textContent = "–";
    console.error(err);
});

   function updateData() {
    fetch(URL)
    .then(res => res.json())
    .then(data => {
        const global = Math.round(data.global);

        // Met à jour le cercle (sans refaire l'animation complète si tu veux)
        const color = colorFromPercent(global);
        circle.style.background = `conic-gradient(${color} ${global * 3.6}deg, #1e293b 0deg)`;
        globalValue.textContent = global;

        // Supprime les anciens détails
        details.innerHTML = '';

        // Ajoute les barres de détail
        data.details.forEach(task => {
            const p = Math.round(task.progress);
            const color = colorFromPercent(p);

            const div = document.createElement("div");
            div.className = "task";

            div.innerHTML = `
                <div class="task-name">${task.name} – ${p}%</div>
                <div class="bar">
                    <div class="bar-fill" style="width:${p}%; background:${color};"></div>
                </div>
            `;
            details.appendChild(div);
        });
    })
    .catch(err => {
        console.error(err);
        globalValue.textContent = "–";
    });
}

// Appel initial
updateData();

// Rafraîchissement toutes les 30 secondes
setInterval(updateData, 30000);
   
</script>

</body>
</html>
